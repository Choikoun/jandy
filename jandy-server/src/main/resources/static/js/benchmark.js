// Generated by CoffeeScript 1.8.0
(function() {
  var Benchmark, findById, toggle, traverse;

  traverse = function(node, fn, level) {
    var child, _i, _len, _ref, _results;
    level = level || 0;
    if (node.root === false) {
      fn(node, level);
    }
    _ref = node.children;
    _results = [];
    for (_i = 0, _len = _ref.length; _i < _len; _i++) {
      child = _ref[_i];
      _results.push(traverse(child, fn, level + 1));
    }
    return _results;
  };

  findById = function(root, nodeId) {
    var node;
    node = null;
    traverse(root, function(n) {
      if (n.id === parseInt(nodeId)) {
        return node = n;
      }
    });
    return node;
  };

  toggle = function(elem, name) {
    var check, oldValue;
    oldValue = elem.attr(name);
    check = elem.data('toggle-check-' + name);
    if (check === void 0) {
      check = true;
    }
    elem.attr(name, elem.data('toggle-' + name));
    elem.data('toggle-' + name, oldValue);
    elem.data('toggle-check-' + name, !check);
    return check;
  };

  Benchmark = (function() {
    function Benchmark(templates, $menus) {
      this.templates = templates;
      this.$menus = $menus;
    }

    Benchmark.prototype.drawTraceTrees = function(root) {
      var h, mm, paper, width;
      this.$menus.html('');
      $("#canvas").html('');
      paper = Raphael("canvas", '100%', 600);
      width = $("#canvas").width();
      h = 25;
      mm = {
        min: Number.MAX_VALUE,
        max: Number.MIN_VALUE
      };
      traverse(root, function(node) {
        if (node.startTime < mm.min) {
          mm.min = node.startTime;
        }
        if (node.startTime + node.elapsedTime > mm.max) {
          return mm.max = node.startTime + node.elapsedTime;
        }
      });
      mm.aspects = 1 / (mm.max - mm.min);
      traverse(root, function(node, level) {
        node.r = {};
        node.r.left = (node.startTime - mm.min) * mm.aspects * width;
        node.r.right = (node.startTime + node.elapsedTime - mm.min) * mm.aspects * width;
        return node.r.top = h * level;
      });
      return traverse(root, (function(_this) {
        return function(node) {
          var child, left, makeRect, _i, _len, _ref;
          makeRect = function(left, top, width, height) {
            var rect;
            rect = paper.rect(left, top, width, height).attr('fill', '#99cc00').attr('stroke', '#000').attr('title', node.method.owner.packageName + '.' + node.method.owner.name + '.' + node.method.name + node.method.descriptor).data('toggle-stroke', '#ff0');
            rect.dblclick(function() {
              window.history.pushState(root, null, '#' + node.id);
              return _this.drawTraceTrees(node);
            });
            rect.click(function() {
              if (toggle(rect, 'stroke')) {
                return _this.$menus.append(_this.templates.menus({
                  id: node.id,
                  "package": node.method.owner.packageName,
                  className: node.method.owner.name,
                  method: node.method.name,
                  parameter: node.method.descriptor,
                  duration: (node.elapsedTime / 1000000000).toFixed(3)
                }));
              } else {
                return _this.$menus.find('#info-' + node.id).remove();
              }
            });
            return rect;
          };
          left = node.r.left;
          _ref = node.children;
          for (_i = 0, _len = _ref.length; _i < _len; _i++) {
            child = _ref[_i];
            if (child.r.right - child.r.left > 2) {
              makeRect(left, node.r.top, child.r.left - left, h);
              left = child.r.right;
            }
          }
          if (node.r.right - left > 2) {
            return makeRect(left, node.r.top, node.r.right - left, h);
          }
        };
      })(this));
    };

    Benchmark.prototype.start = function(profId) {
      return $.get(ROOT_URL + "/rest/prof/" + profId).done((function(_this) {
        return function(prof) {
          _this.draw(prof.root);
          return $(window).on('popstate', function() {
            return _this.draw(prof.root);
          });
        };
      })(this));
    };

    Benchmark.prototype.draw = function(root) {
      if (window.location.hash === null || window.location.hash === '') {
        return this.drawTraceTrees(root);
      } else {
        return this.drawTraceTrees(findById(root, window.location.hash.replace('#', '')));
      }
    };

    return Benchmark;

  })();

  greem.Benchmark = Benchmark;

}).call(this);

//# sourceMappingURL=benchmark.js.map
